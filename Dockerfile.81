FROM php:8.1-apache

ARG DEV_USER_UID=1000
ENV TERM=xterm-256color

ADD /rootfs/docker-build/ /docker-build/

RUN mkdir -p /tmp/summary && chmod 775 /tmp/summary
RUN bash /docker-build/99-summary.sh | tee '/tmp/summary/pre-summary.log'
RUN /docker-build/installed-extensions.sh > '/tmp/summary/pre-extensions.json'

RUN apt-get update
RUN apt-get upgrade -y
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    cron \
    curl \
    git \
    htop \
    nano \
    openssh-client \
    screen \
    ssl-cert \
    sudo \
    unzip \
    wget

RUN /usr/sbin/update-ca-certificates

ADD https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions /usr/local/bin/
RUN chmod +x /usr/local/bin/install-php-extensions && sync && install-php-extensions \
 bcmath \
 gd \
 intl \
 mcrypt \
 pcntl \
 xdebug \
 zip

RUN /docker-build/installed-extensions.sh > '/tmp/summary/post-extensions.json'

ADD rootfs /

ADD config/xdebug3.ini /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini

RUN (bash /docker-build/00-user.sh) && \
    (bash /docker-build/10-bash.sh) && \
    (bash /docker-build/20-apache.sh) && \
    (bash /docker-build/50-composer.sh) && \
    (bash /docker-build/60-symfony.sh) && \
    (bash /docker-build/70-phpunit.sh 8 9) && \
    (bash /docker-build/90-utils.sh)

USER dev

ADD --chown=dev:dev home-dev /home/dev/

VOLUME /www
WORKDIR /www

EXPOSE 80
EXPOSE 443

CMD ["sudo", "apache2-foreground"]

RUN bash /docker-build/99-summary.sh | sudo tee '/tmp/summary/post-summary.log'
RUN sudo chown -R dev:dev /tmp/summary/

