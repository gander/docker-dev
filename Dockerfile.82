FROM php:8.2-apache

ARG DEV_USER_UID=1000
ENV TERM=xterm-256color

RUN apt-get update && \
    apt-get upgrade -y && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    cron \
    curl \
    git \
    htop \
    jq \
    nano \
    openssh-client \
    screen \
    ssl-cert \
    sudo \
    unzip \
    wget

RUN /usr/sbin/update-ca-certificates

ADD rootfs /

RUN (bash /setup/00-user.sh) && \
    (bash /setup/10-bash.sh) && \
    (bash /setup/20-apache.sh) && \
    (bash /setup/30-php.sh \
        bcmath-stable \
        gd-stable \
        intl-stable \
        pcntl-stable \
        pdo_mysql-stable \
        pdo_pgsql-stable \
        xdebug-^3.2 \
        zip-stable \
    )
RUN (bash /setup/50-composer.sh) && \
    (bash /setup/60-symfony-cli.sh) && \
    (bash /setup/70-phpunit.sh 8 9 10) && \
    (bash /setup/90-utils.sh) && \
    (rm -fr /setup/)

RUN rm -rf /var/lib/apt/lists/*

ADD config/xdebug3.ini /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini

USER dev

VOLUME /www
WORKDIR /www

EXPOSE 80
EXPOSE 443

CMD ["sudo", "apache2-foreground"]
